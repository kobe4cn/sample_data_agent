# 数据准备指南

本指南帮助您准备数据文件，以便智能数据分析助手能够正确处理和分析。

## 目录

- [常见问题](#常见问题)
- [快速检查清单](#快速检查清单)
- [一分钟上手指南](#一分钟上手指南)
- [详细处理步骤](#详细处理步骤)
- [示例场景](#示例场景)
- [常见错误及解决方案](#常见错误及解决方案)
- [最佳实践建议](#最佳实践建议)
- [需要帮助](#需要帮助)
- [文档可读性自检](#文档可读性自检)

---

## 常见问题

### 1. Excel文件无法正确读取

**症状**：
- 列名显示为 `Unnamed: 0`, `Unnamed: 1` 等
- 数据从错误的行开始读取
- 缺少部分列或数据

**原因**：
- Excel文件包含多层表头
- 文件顶部有说明文字或元信息
- 表头行不在第一行

**解决方法**：
参见 [处理多层表头](#处理多层表头)

---

### 2. 绘图时提示列名不存在

**症状**：
```
KeyError: "None of ['某列名'] are in the columns"
ValueError: Could not interpret value 'XXX' for 'x'
```

**原因**：
- 列名在文件中实际不存在
- 列名包含特殊字符或空格
- 多层表头导致列名异常

**解决方法**：
参见 [检查和清理列名](#检查和清理列名)

---

### 3. 数值计算错误

**症状**：
- 统计结果为 NaN
- 无法进行数学运算
- 类型错误（TypeError）

**原因**：
- 数值列包含文本或特殊字符（如逗号、百分号）
- 数据类型被识别为 object 而非 float/int

**解决方法**：
参见 [数据类型转换](#数据类型转换)

---

## 快速检查清单

在上传数据文件之前，请确认：

- [ ] **文件格式**：推荐使用 CSV 格式（UTF-8编码）
- [ ] **表头位置**：确保表头在第一行，或清楚知道表头在哪一行
- [ ] **列名简洁**：避免使用特殊字符、空格、或过长的列名
- [ ] **单层表头**：避免使用合并单元格或多层表头
- [ ] **数据类型**：
  - 数值列不包含文本、逗号、单位等
  - 日期列格式统一（如 `YYYY-MM-DD`）
  - 分类列拼写一致
- [ ] **无空行空列**：删除多余的空行和空列
- [ ] **编码正确**：使用 UTF-8 编码保存

---

## 一分钟上手指南

> 想快速验证复杂 Excel/CSV 文件是否可直接用于分析？按照以下 4 个步骤即可在 60 秒内完成初检。

1. **查看原始结构**
   ```python
   import pandas as pd
   df_raw = pd.read_excel('data/lego.xlsx', header=None)
   print(df_raw.head(10))
   ```
   - 可立即识别多层表头、说明文字或空行。
   - 如果需要练习，可使用附带的 `data/test_multiheader.xlsx`。

2. **锁定真实表头行**
   ```python
   df = pd.read_excel('data/lego.xlsx', header=5)  # 或者 skiprows=5
   ```
   - 一旦确认表头所在行，立刻重新读取。
   - 表头不在第一行时务必记录索引，方便复现。

3. **清理列名 + 删除 Unnamed 列**
   ```python
   df = df.loc[:, ~df.columns.astype(str).str.contains('^Unnamed')]
   df.columns = df.columns.str.strip()
   print(df.columns.tolist())
   ```
   - 始终在绘图、聚合前执行这一操作，防止 KeyError。

4. **按需转换宽表为长表**
   ```python
   df_long = df.melt(
       id_vars=['产品'], value_vars=['Q1', 'Q2', 'Q3', 'Q4'],
       var_name='季度', value_name='销售额'
   )
   ```
   - 适用于 `data/test_wide.csv` 这类季度宽表，便于直接使用 seaborn。

完成以上步骤后，您就拥有一份可直接绘图的干净 DataFrame；若仍存在疑问，把列名列表贴给 AI，即可继续后续分析。

---

## 详细处理步骤

### 处理多层表头

如果您的Excel文件包含多层表头或顶部说明文字：

#### 系统内置支持
- 内置数据集（如 `lego.xlsx`）现已预清洗：直接执行 `lego_df = load_dataset('lego')` 即可获得单层列名，所有 `Unnamed` 列已移除，可直接用于分组/绘图。
- 如需查看清洗后的列名，可运行 `print(lego_df.columns.tolist())`，或在绘图代码中引用诸如 `孩子_Passion互动%`、`婴童家长_人群交Passion曝光base` 等字段。

#### 自定义文件：使用 helper 一次处理
```python
from src_agent.data_loader import load_multiheader_excel

df = load_multiheader_excel(
    'data/custom_report.xlsx',
    header_row=3,      # 或使用 header_rows=(2, 5) 精确指定行
    depth=2,           # 表头层级数量
)
```
- helper 会自动跳过元信息行、删除 `Unnamed` 列、扁平化 MultiIndex。
- 若希望保留空列，可设置 `drop_unnamed=False`；若表头行不连续，可传入 `header_rows=(2, 5)`。

#### 方法1：让AI助手帮您处理

当您上传文件后，可以这样提问：

```
请先检查 data/myfile.xlsx 的文件结构，查看前10行，
然后告诉我表头在哪一行。
```

AI助手会执行：
```python
import pandas as pd
df_raw = pd.read_excel('data/myfile.xlsx', header=None)
print(df_raw.head(10))
```

然后您可以根据结果，告诉AI：
```
表头在第5行（索引4），请跳过前面4行重新读取数据。
```

#### 方法2：自己准备清洁的CSV

最简单的方法是在Excel中：
1. 删除顶部的说明行
2. 确保表头在第一行
3. 删除合并的单元格
4. 另存为 CSV（UTF-8）格式

---

### 检查和清理列名

#### 查看实际列名

上传文件后，先让AI检查列名：

```
请读取 data/myfile.csv，并显示所有列名。
```

AI助手会执行：
```python
import pandas as pd
df = pd.read_csv('data/myfile.csv')
print("可用列名:", df.columns.tolist())
```

#### 清理列名

如果列名包含空格、特殊字符或中文，可以让AI清理：

```
请清理列名，去除空格，并将空格替换为下划线。
```

AI助手会执行：
```python
df.columns = df.columns.str.strip()  # 去除首尾空格
df.columns = df.columns.str.replace(' ', '_')  # 替换空格为下划线
print("清理后的列名:", df.columns.tolist())
```

#### 处理 Unnamed 列

如果看到 `Unnamed: 0` 等列名，通常是Excel的索引列或空列：

```
请删除所有 Unnamed 开头的列。
```

AI助手会执行：
```python
df = df.loc[:, ~df.columns.str.contains('^Unnamed')]
```

---

### 数据类型转换

#### 检查数据类型

```
请检查数据类型，显示每列的类型。
```

AI助手会执行：
```python
print(df.dtypes)
```

#### 转换数值列

如果数值列显示为 `object` 类型：

```
请将 '销售额' 和 '数量' 列转换为数值类型。
```

AI助手会执行：
```python
df['销售额'] = pd.to_numeric(df['销售额'], errors='coerce')
df['数量'] = pd.to_numeric(df['数量'], errors='coerce')
```

如果列中包含逗号、货币符号或百分号：

```
请处理 '金额' 列中的逗号，然后转换为数值。
```

AI助手会执行：
```python
df['金额'] = df['金额'].str.replace(',', '').astype(float)
df['比例'] = df['比例'].str.rstrip('%').astype(float) / 100
```

#### 转换日期列

```
请将 '日期' 列转换为日期类型。
```

AI助手会执行：
```python
df['日期'] = pd.to_datetime(df['日期'], errors='coerce')
```

---

### 宽表转长表（用于绘图）

如果您的数据是宽表格式（多列表示不同时间点或类别），需要转换为长表才能用 seaborn 绘图。

#### 宽表示例：

| 产品 | 1月销售额 | 2月销售额 | 3月销售额 |
|------|----------|----------|----------|
| A    | 100      | 120      | 130      |
| B    | 80       | 90       | 95       |

#### 转换为长表：

```
请将销售额数据从宽表转换为长表格式，
保留 '产品' 列，将月份作为新列。
```

AI助手会执行：
```python
df_long = df.melt(
    id_vars=['产品'],
    value_vars=['1月销售额', '2月销售额', '3月销售额'],
    var_name='月份',
    value_name='销售额'
)
```

#### 长表结果：

| 产品 | 月份      | 销售额 |
|------|----------|--------|
| A    | 1月销售额 | 100    |
| A    | 2月销售额 | 120    |
| A    | 3月销售额 | 130    |
| B    | 1月销售额 | 80     |
| B    | 2月销售额 | 90     |
| B    | 3月销售额 | 95     |

---

## 示例场景

### 场景1：分析复杂的Excel销售报表

**原始文件结构**：
```
行1: 公司名称：XXX有限公司
行2: 报告日期：2024年1月
行3: [空行]
行4: 分类 | 子分类 | 产品 | 销售额 | 数量
行5: 实际数据开始...
```

**处理步骤**：

1. 检查文件结构：
```
请检查 data/sales_report.xlsx 的前10行结构。
```

2. 重新读取，跳过前3行：
```
请跳过前3行，从第4行开始读取数据。
```

3. 检查列名和数据类型：
```
请显示列名和数据类型。
```

4. 清洗数据：
```
请删除空列，并将 '销售额' 和 '数量' 转换为数值类型。
```

5. 开始分析：
```
请按 '分类' 分组，计算总销售额，并绘制柱状图。
```

---

### 场景2：绘制多时间点趋势图

**数据格式**（宽表）：
```csv
产品,Q1销售额,Q2销售额,Q3销售额,Q4销售额
A,100,120,130,150
B,80,85,90,100
```

**处理步骤**：

1. 转换为长表：
```
请读取 data/quarterly_sales.csv，
然后转换为长表格式，季度作为新列。
```

2. 绘制趋势图：
```
请绘制每个产品的季度销售额趋势图，使用折线图。
```

---

## 常见错误及解决方案

### 错误1：UnicodeDecodeError

**错误信息**：
```
UnicodeDecodeError: 'utf-8' codec can't decode byte...
```

**原因**：文件编码不是 UTF-8

**解决方案**：
- 在Excel中另存为 CSV（UTF-8）
- 或告诉AI使用不同编码：
  ```
  请使用 gbk 编码读取文件。
  ```

---

### 错误2：KeyError: 'column_name'

**错误信息**：
```
KeyError: 'passion_系列'
```

**原因**：列名不存在

**解决方案**：
1. 先检查实际列名：
   ```
   请显示所有列名。
   ```

2. 使用实际存在的列名，或创建新列：
   ```
   请创建新列 'passion_系列'，由 '人群' 和 '系列' 列组合而成。
   ```

---

### 错误3：TypeError: unsupported operand type(s)

**错误信息**：
```
TypeError: unsupported operand type(s) for +: 'int' and 'str'
```

**原因**：数值列的数据类型是 object（文本）

**解决方案**：
```
请将 '销售额' 列转换为数值类型。
```

---

### 错误4：所有列都是 Unnamed

**原因**：Excel文件的真实表头不在第一行

**解决方案**：
1. 检查文件结构：
   ```
   请以 header=None 读取文件，显示前10行。
   ```

2. 确定表头位置后重新读取：
   ```
   表头在第5行，请重新读取数据。
   ```

---

## 最佳实践建议

1. **优先使用CSV格式**
   - 简单、通用、不易出错
   - 避免Excel的复杂格式问题

2. **保持数据简洁**
   - 一个文件只包含一张表
   - 表头在第一行
   - 无合并单元格、无多层表头

3. **列名规范**
   - 使用英文或拼音（可选）
   - 避免空格，使用下划线
   - 避免特殊字符

4. **数据类型明确**
   - 数值就是数值，不要加单位、逗号
   - 日期使用统一格式
   - 分类列拼写一致

5. **先清洗，后分析**
   - 上传文件后，先让AI检查数据质量
   - 清理列名、转换类型
   - 保存清洗后的结果
   - 然后进行分析和绘图

6. **利用AI助手**
   - 不确定数据格式时，让AI先检查
   - 让AI帮您清洗和转换数据
   - 遇到错误时，将错误信息告诉AI

---

## 需要帮助？

如果您遇到本指南未覆盖的问题，可以直接向AI助手提问：

```
我的数据文件有[具体问题描述]，应该如何处理？
```

AI助手会根据您的具体情况提供解决方案。

---

## 文档可读性自检

- **评估时间**：2025-11-18（内部走查）
- **方法**：使用 `data/test_multiheader.xlsx` 与 `data/test_wide.csv` 手动按照[一分钟上手指南](#一分钟上手指南)执行，记录每一步的指令是否可直接复制、是否需要额外背景知识。
- **发现**：
  - 原文缺少紧凑的操作步骤，首次阅读者需要在多个章节来回跳转。
  - 对练习文件的引用不足，导致读者难以自行验证。
- **改进**：
  - 新增「一分钟上手指南」提供 4 步快速流程，并将练习文件直接链接到对应步骤。
  - 在每个代码块上方补充“何时使用”“为什么这么做”的说明，减少技术术语。
- **下一步**：
  - 待团队演示会（详见 `DATA_PREPROCESSING_P0_IMPLEMENTATION.md`）结束后，再根据真实的非技术反馈调整措辞。

如需提供更多可读性反馈，可在 issue 中附上原始数据样本与困惑点，我们会继续迭代本指南。
